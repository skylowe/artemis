# ARTEMIS Configuration: TR2025 Intermediate Assumptions
# Source: SSA Office of the Chief Actuary, 2025 Trustees Report

metadata:
  trustees_report_year: 2025
  alternative: "Intermediate"
  alternative_number: 2
  projection_period:
    start_year: 2023  # Default: TR_YEAR - 2 (= 2023). Changed from 2024 to include TR2025's estimated 2023 immigration
    end_year: 2100    # Default: TR_YEAR + 75 (= 2100). Independent — set explicitly for each TR.
  valuation_date: "2025-01-01"

fertility:
  # Ultimate cohort TFR assumption
  ultimate_ctfr: 1.90
  # Age range for fertility calculations
  min_fertility_age: 14
  max_fertility_age: 49
  # Reference age for ratio calculations
  # TR2025 methodology uses age 30 as the reference. Changing this value would
  # deviate from the standard methodology and is not recommended.
  reference_age: 30
  # Ultimate attainment years
  # projection_start_year: derived from TR_YEAR (= 2025)
  # TR2025: Year when oldest fertility age (49) reaches ultimate rate
  # Formula: u_x = 2025 + (x-14) * (2050-2025) / (49-14)
  # Age 30 reaches ultimate in 2036 (derived from this formula)
  # ultimate_year: derived from TR_YEAR + 25 (= 2050)
  # Interpolation weight exponent (TR2025 uses 1.5)
  # 1.0 = linear, >1 = front-loaded (faster initial change)
  weight_exponent: 1.5
  # Base year for projections
  # TR2025 uses 2024 with estimated rates (TFR=1.62 from provisional data)
  # rate_base_year: derived from TR_YEAR - 1 (= 2024)
  # Override TFR for recent years where final NCHS data may differ from TR assumptions
  # Typically applies to TR_year - 1 and TR_year - 2 (e.g., 2023 and 2024 for TR2025),
  # where only provisional data was available when the TR was published.
  # When set, scales age-specific rates proportionally to hit the specified TFR.
  # Set to null to use actual NCHS-derived rates (default, recommended for accuracy).
  # Example to match TR2025 estimates:
  #   custom_recent_tfr:
  #     2023: 1.62
  #     2024: 1.62
  custom_recent_tfr: null
  # Years to exclude from trend calculations
  exclude_years:
    - 1997  # NCHS age imputation method change

mortality:
  # Projection parameters
  base_year: 2019  # Last pre-COVID year used for starting values
  ultimate_year: 2043    # Year when ultimate AAx values are reached

  # Regression parameters (for calculating historical AAx)
  regression_start_year: 2008
  regression_end_year: 2019

  # =========================================================================
  # Mortality Projection Source
  # =========================================================================
  # Controls the overall mortality projection methodology.
  #
  # Options:
  #   "regression" - ARTEMIS independent projection. Calculates AAx from weighted
  #                  regression on 2008-2019 NCHS data, projects mx forward by
  #                  cause, converts to qx, applies HMD calibration and ALB.
  #                  Use with by_cause: true.
  #   "tr_qx"     - Uses TR2025's published death probabilities directly for all
  #                  projection years (2023-2099). Bypasses the entire projection
  #                  pipeline (AAx trajectory, mx projection, smoothing, COVID
  #                  adjustments). Ensures exact alignment with TR2025 mortality.
  # =========================================================================
  starting_aax_method: "regression"  # Options: "regression", "tr_qx"

  # Configuration for "tr_qx" method
  starting_tr_qx:
    # Path to TR2025 death probability files (relative to project root)
    # Projected files (2023-2100)
    male_qx_file: "data/raw/SSA_TR2025/DeathProbsE_M_Alt2_TR2025.csv"
    female_qx_file: "data/raw/SSA_TR2025/DeathProbsE_F_Alt2_TR2025.csv"
    # Historical files (1900-2022)
    male_qx_hist_file: "data/raw/SSA_TR2025/DeathProbsE_M_Hist_TR2025.csv"
    female_qx_hist_file: "data/raw/SSA_TR2025/DeathProbsE_F_Hist_TR2025.csv"
    # Base year for starting qx (2023 = first year TR2025 projected file covers)
    # base_year: derived from projection_period.start_year (= 2023)
    # Years to use for calculating implied AAx (2024-2025 gives first year improvement)
    aax_reference_years: [2024, 2025]

  # Apply COVID-19 adjustment factors to projected qx (TR2025 Eq 1.2.3)
  # Multiplies qx by age-group-specific factors for 2024-2025.
  # Set to false to project from pure pre-COVID trends.
  apply_covid_adjustments: true

  # COVID-19 adjustment factors (applied to qx in 2024-2025)
  covid_adjustments:
    2024:
      age_0: 1.01
      age_1_14: 1.17
      age_15_64: 0.99
      age_65_84: 1.02
      age_85_plus: 0.98
    2025:
      age_0: 1.00
      age_1_14: 1.09
      age_15_64: 1.00
      age_65_84: 1.00
      age_85_plus: 1.00

  # Project mortality rates by cause of death (6 categories), then sum to total.
  # Per TR2025 Eq 1.2.1-1.2.2, mx is projected separately for each cause.
  # Only applies to regression method; tr_qx method ignores this setting.
  by_cause: true

  # Use CDC WONDER provisional data for the most recent death year.
  # The provisional year is auto-derived as trustees_report_year - 2.
  # Set to false if final NCHS microdata is available for that year.
  use_wonder_provisional: true

  # Elderly AAx cap (ages 85+)
  # Caps the projected annual reduction rate (AAx) for ages above start_age.
  # ARTEMIS regression-derived AAx rises with age above 85, reaching ~0.75% at
  # age 99 — 43% faster than TR2025's flat ~0.55%. This compounds over the 75-year
  # projection to produce 30-50% divergence. Enabling this cap flattens the AAx
  # at elderly ages to match TR2025's observed pattern.
  # Only applies in regression mode; tr_qx mode uses TR2025 values directly.
  elderly_aax_cap:
    enabled: false
    start_age: 85          # Age above which AAx is capped
    max_aax: 0.0055        # Maximum total AAx (~0.55%, matching TR2025 pattern)

  # HMD calibration for elderly mortality (ages 85+)
  # Adjusts qx at ages 85-99 using Human Mortality Database mortality ratios
  # anchored at age 84. This compensates for unreliable NCHS/Census data at
  # advanced ages (CMS Medicare data used by TR2025 is not publicly available).
  # Set to false to use raw NCHS/Census-derived qx at all ages.
  hmd_calibration:
    enabled: true
    transition_age: 85       # Age at which HMD adjustment begins
    reference_year: 2019     # HMD reference year for ratio calculation

  # Marital mortality differentials
  # TR2025 Section 1.2.c: reference years for calculating marital mortality factors
  marital_reference_years: [2015, 2016, 2017, 2018, 2019]
  # TR2025 Section 1.2.c Step 5: WH smoothing with degree=2, smoothing=0.01
  marital_smoothing_parameter: 0.01

  # =========================================================================
  # Ultimate Annual Percentage Reductions (AAx) by Age Group and Cause
  # =========================================================================
  # These are the long-term assumed rates of mortality improvement.
  # Values are percentages (e.g., 1.9 = 1.9% annual reduction in death rates)
  # Source: TR2025 Appendix 1.2-1, Intermediate Assumptions
  #
  # To customize: modify these values or create alternative config files
  # (e.g., tr2025_low_cost.yaml, tr2025_high_cost.yaml)
  # =========================================================================

  ultimate_aax:
    # Age group: Under 15 (ages 0-14)
    under_15:
      CVD: 1.9   # Cardiovascular disease
      CAN: 1.5   # Cancer (malignant neoplasms)
      ACV: 1.0   # Accidents and violence
      RES: 2.0   # Respiratory disease
      DEM: 0.1   # Dementia
      OTH: 1.7   # All other causes

    # Age group: 15-49
    age_15_49:
      CVD: 1.3
      CAN: 1.5
      ACV: 0.7
      RES: 0.5
      DEM: 0.1
      OTH: 0.8

    # Age group: 50-64
    age_50_64:
      CVD: 1.5
      CAN: 1.5
      ACV: 0.5
      RES: 0.7
      DEM: 0.1
      OTH: 0.6

    # Age group: 65-84
    age_65_84:
      CVD: 1.9
      CAN: 0.9
      ACV: 0.5
      RES: 0.3
      DEM: 0.1
      OTH: 0.3

    # Age group: 85+ (ages 85-119)
    age_85_plus:
      CVD: 1.5
      CAN: 0.5
      ACV: 0.3
      RES: 0.2
      DEM: 0.1
      OTH: 0.3

  # Age group boundaries for ultimate AAx
  age_groups:
    under_15:
      min_age: 0
      max_age: 14
    age_15_49:
      min_age: 15
      max_age: 49
    age_50_64:
      min_age: 50
      max_age: 64
    age_65_84:
      min_age: 65
      max_age: 84
    age_85_plus:
      min_age: 85
      max_age: 119

immigration:
  # =========================================================================
  # LPR Immigration Configuration (TR2025 Intermediate Assumptions)
  # =========================================================================
  # Source: SSA 2025 Long-Range Model Documentation, Section 1.3
  #
  # NOTE: Total LPR immigration levels are loaded from Table V.A2 (va2_file).
  # The config options below control age-sex distribution methods and overrides.

  lpr:
    # =========================================================================
    # LPR Assumptions Source
    # =========================================================================
    # Controls the source of aggregate LPR immigration/emigration totals.
    #
    # Options:
    #   "va2" - TR2025 Table V.A2 (official Trustees assumptions)
    #           Emigration computed as total_lpr * emigration ratio (from config).
    #   "cbo" - CBO Demographic Outlook 2026-2056 (LPR+ projections, 2021-2099)
    #           CBO provides both immigration and emigration totals directly.
    #           CBO has no NEW/AOS split; DHS historical ratio is used.
    # =========================================================================
    assumptions_source: "va2"

    # =========================================================================
    # Age-Sex Distribution Method (TR2025 Section 1.3)
    # =========================================================================
    # Controls the source of the immigration age-sex distribution.
    #
    # Options:
    #   "dhs" - DHS expanded tables with Beers interpolation (TR2025 methodology)
    #           Uses separate NEW/AOS distributions per Section 1.3.
    #           Note: Public DHS data is in 5-year age groups; SSA receives
    #           non-public single-year data. Beers interpolation compensates.
    #
    #   "tr_derived" - Back-calculated from TR2025 population projections
    #           (ARTEMIS-specific). Computed by target `tr_derived_immigration_dist`.
    #           Ensures population projection aligns with TR2025.
    # =========================================================================
    distribution_method: "dhs"  # Options: "dhs", "tr_derived"

    # When distribution_method = "dhs":
    # - "separate": Separate NEW/AOS distributions per TR2025 Section 1.3
    # - "combined": Single combined distribution, split by ratio (legacy)
    dhs_distribution_mode: "separate"

    # DHS distribution reference years (TR2025 Section 1.3: 2016-2020)
    distribution_years: [2016, 2017, 2018, 2019, 2020]

    # Interpolation method for converting DHS 5-year age groups to single years
    # - "beers": H.S. Beers ordinary interpolation (TR2025 methodology)
    # - "uniform": Uniform distribution within each group (legacy)
    interpolation_method: "beers"

    # Fiscal-year to calendar-year conversion (TR2025 Section 1.3 step 2)
    # CY_z = 0.75 * FY_z + 0.25 * FY_{z+1}
    convert_fy_to_cy: true

    # TR-derived distribution years (averaged over these years)
    tr_derived_years: [2023, 2024, 2025, 2026, 2027, 2028, 2029, 2030]

    # =========================================================================
    # Elderly Override for TR-Derived Method (Ages 65+)
    # =========================================================================
    # The TR-derived distribution has unreliable values for ages 65+ because:
    # - Small population sizes amplify calculation errors
    # - Age 100+ is an open-ended group with different dynamics
    # - Excess immigration at 65-84 compounds into 85-99 divergence over time
    #
    # Analysis shows TR-derived distribution overestimates elderly immigration:
    # - Ages 65-84: Our ~105-168K/year vs TR2025 implied ~35-76K/year (2-3x higher)
    # - Ages 85-99: Our ~73K/year vs TR2025 implied ~10K/year
    # - Ages 100+: Our ~61K/year vs TR2025 implied ~350/year
    #
    # These overrides set explicit values based on TR2025 implied immigration,
    # calculated by analyzing population transitions with age-last-birthday qx.
    # =========================================================================
    elderly_override_tr_derived:
      enabled: false
      # Ages 65-84: TR2025 implies ~50,000-75,000 net immigrants per year
      # Our TR-derived shows 105K-168K (2-3x higher)
      # Using ~60,000 as middle estimate (average of implied range)
      # Male: ~27,000, Female: ~33,000 (55% female share)
      ages_65_84:
        annual_total: 60000
        female_share: 0.55
      # Ages 85-99: TR2025 implies ~8,000-10,000 net immigrants per year
      # Calculated from: Imm = P(x,t) - P(x-1,t-1) * (1 - qx_alb)
      # Male: ~3,700, Female: ~4,300 (54% female share)
      ages_85_99:
        annual_total: 8000
        female_share: 0.54
      # Ages 100+: TR2025 implies ~350 net immigrants per year
      # Calculated using open-ended group formula:
      # Imm = P(100+,t) - P(99,t-1)*(1-q99) - P(100+,t-1)*(1-q100+)
      # Male: ~115, Female: ~220 (65% female share due to longevity)
      age_100_plus:
        annual_total: 350
        female_share: 0.65

    # =========================================================================
    # Elderly Immigration Override (Ages 85+) - FOR DHS METHOD ONLY
    # =========================================================================
    # Only used when distribution_method = "dhs"
    # DHS data shows almost no immigration at ages 85+ (~0.03% of total).
    # However, TR2025 population projections imply ~3.5% of net immigration
    # goes to ages 85-99. This override adjusts for this discrepancy.
    # =========================================================================
    elderly_override:
      enabled: true
      ages_85_99:
        annual_total: 68500
        female_share: 0.60
      age_100_plus:
        annual_total: -4000
        female_share: 0.65

    # NEW/AOS split method:
    # - "assumption": Use TR2025 V.A2 values directly (450K AOS, recommended)
    # - "ratio": Use historical ratio from DHS data (produces ~533K-616K AOS)
    new_aos_split_method: "assumption"

    # NEW/AOS ratio reference years (DHS aggregate data)
    # Only used when new_aos_split_method = "ratio"
    # TR2025 Section 1.3 uses 2016-2020
    new_aos_ratio_years: [2016, 2017, 2018, 2019, 2020]

  # =========================================================================
  # Legal Emigration Configuration
  # =========================================================================

  emigration:
    # Emigration ratio: fraction of LPR immigration that emigrates
    # TR2025 Section 1.3.c Eq 1.3.4: E = 0.25 * L (25% of gross LPR)
    # Only applied when lpr.assumptions_source = "va2"
    # When assumptions_source = "cbo", CBO provides emigration totals directly
    ratio: 0.25

    # Distribution source for emigration age-sex pattern:
    # - "cbo": CBO LPR+ emigration data (best available public approximation
    #          of TR2025's Census 1980-1990 estimates)
    # - "dhs": Same distribution as immigration (legacy, methodologically incorrect)
    distribution_source: "cbo"

    # CBO emigration reference years (recent historical CBO estimates)
    cbo_reference_years: [2021, 2022, 2023, 2024]

    # DHS fallback distribution years (only used when distribution_source = "dhs")
    # TR2025 Section 1.3 reference period: 2016-2020
    distribution_years: [2016, 2017, 2018, 2019, 2020]

  # =========================================================================
  # Approximate Net Immigration (for distribution scaling only)
  # =========================================================================
  # These values are used ONLY for calculating elderly override proportions
  # in get_lpr_distribution_for_projection(). They provide an approximate
  # total net immigration to scale the age 65+ overrides correctly.
  #
  # Actual immigration totals come from Table V.A2 (va2_file).
  # If you change V.A2 alternative or file, these approximations may need
  # adjustment to maintain proper elderly override proportions.
  #
  # Calculation: ultimate_net_lpr + (ultimate_gross_o * 0.5)
  #   = 787,500 + (1,350,000 * 0.5) = 1,462,500 ≈ 1.46M
  ultimate_net_lpr_immigration: 787500

  # =========================================================================
  # Table V.A2 - Immigration Assumptions
  # =========================================================================
  # Net immigration values are loaded directly from TR2025 Table V.A2
  # This ensures exact alignment with Trustees Report assumptions
  va2_file: "data/raw/SSA_TR2025/SingleYearTRTables_TR2025.xlsx"
  va2_alternative: "intermediate"  # Options: "intermediate", "low", "high"

  # CBO migration data file (used when lpr.assumptions_source = "cbo")
  cbo_file: "data/raw/cbo/grossMigration_byYearAgeSexStatusFlow.csv"

  # =========================================================================
  # O (Other/Temp/Unlawful) Immigration Configuration
  # =========================================================================
  # Net O immigration values come directly from V.A2 (va2_file), which shows:
  # - 2025: 1,192K net O
  # - 2026: 517K net O
  # - 2027+: Declining from 513K to 448K (emigration grows with stock)
  #
  # The values below are used ONLY for:
  # 1. Approximate total net immigration calculation (for elderly override scaling)
  # 2. ODIST calculation in temp_unlawful_immigration.R
  #
  # Actual net O totals come from Table V.A2.
  o_immigration:
    # Gross O immigration (ultimate, from 2026+)
    # TR2025: 1,350,000 for unauthorized + nonimmigrant arrivals
    # Used for: elderly override scaling (as ~50% net proxy)
    ultimate_gross_o: 1350000

    # Transition year gross (2025 only - higher due to policy assumptions)
    # Note: Currently not used in code; included for documentation
    transition_gross_o: 2000000

    # TR2025 Section 1.5, Input #1: year-specific gross O immigration totals
    # "The ultimate annual level is 1,350,000 for each year beginning in 2026.
    # The level is estimated to be 2,200,000, 2,700,000, 2,600,000, and
    # 2,000,000 for years 2022-25, respectively."
    total_by_year:
      2022: 2200000
      2023: 2700000
      2024: 2600000
      2025: 2000000
      # 2026+ uses ultimate_gross_o

    # -----------------------------------------------------------------------
    # Departure rate parameters (TR2025 Section 1.5.c)
    # -----------------------------------------------------------------------
    # Actual SSA rates (Inputs #26-30) not published; these are approximations.
    # Known deviation: TR2025 uses separate rate tables per type/period; ARTEMIS
    # uses multiplicative adjustments on a single base rate schedule.
    departure_rates:
      n_pre_2015_multiplier: 1.20
      n_post_2015_multiplier: 0.80
      n_recent_arrival_multiplier: 2.0  # TR2025 explicit: "twice the rates"
      ni_initial_multiplier: 0.70
      ni_ultimate_multiplier: 1.00
      ni_transition_start_year: 2015
      ni_transition_end_year: 2025
      v_pre_2015_multiplier: 1.10
      v_post_2015_multiplier: 0.85
      daca_rate_reduction: 0.50
      recent_arrival_years: 5
      recent_arrival_proportion: 0.30   # Pct of N that are recent arrivals
      recession_factor: 0.85            # Recession adjustment (2008-2010 period)
      recession_working_age_factor: 0.95

    # -----------------------------------------------------------------------
    # AOS type distribution (TR2025 LPR Immigration subprocess)
    # -----------------------------------------------------------------------
    # AOS (adjustment of status) comes from nonimmigrants and visa-overstayers
    # who regularize their immigration status and become LPRs.
    aos_type_distribution:
      N: 0.00   # Never-authorized cannot directly adjust to LPR
      I: 0.60   # Nonimmigrants (H-1B->GC, F-1->GC, etc.)
      V: 0.40   # Overstayers who regularize through family/employer

    # -----------------------------------------------------------------------
    # Default type splits (N/I/V) for fallback when detailed data unavailable
    # -----------------------------------------------------------------------
    # Source: DHS unauthorized (~11M) + nonimmigrant (~2M) = ~13M total O
    # N = (11M * 0.60) / 13M ≈ 50%, I = 2M / 13M ≈ 15%, V = (11M * 0.40) / 13M ≈ 35%
    default_type_splits:
      N: 0.50
      I: 0.15
      V: 0.35

    # -----------------------------------------------------------------------
    # Total O population and unauthorized estimates
    # -----------------------------------------------------------------------
    # Source: DHS unauthorized (~11M) + nonimmigrant stock (~2M) = ~13M
    total_o_population: 13000000
    total_unauthorized: 11000000

    # -----------------------------------------------------------------------
    # ACS undercount factors for O immigration calculation
    # -----------------------------------------------------------------------
    # TR2025 uses three-component model (ACS-DHS gap, PUMS-Census gap, PR
    # foreign-born). ARTEMIS uses a single calibrated factor per broad age
    # group. See deviation documentation in temp_unlawful_immigration.R.
    acs_undercount_factors:
      age_0_17: 1.05
      age_18_34: 1.10
      age_35_49: 1.08
      age_50_64: 1.03
      age_65_plus: 1.01

    # -----------------------------------------------------------------------
    # DACA (Deferred Action for Childhood Arrivals) parameters
    # -----------------------------------------------------------------------
    daca:
      total_eligible_2012: 1100000
      male_pct: 0.54
      criminal_exclusion_factor: 0.90
      attainment:
        first_year_base_rate: 0.43   # 472K grants / 1.1M eligible
        second_year_base_rate: 0.15  # 123K / remaining
        ultimate_base_rate: 0.66     # 725K total / 1.1M
        age_adjustment_young: 0.85
        age_adjustment_peak: 1.05
        age_adjustment_older: 0.95
        male_adjustment: 1.02
        female_adjustment: 0.98
        annual_decline_factor: 0.98
      projection:
        base_attrition_rate: 0.03
        departure_rate: 0.01
        death_rate: 0.001
        annual_decline_rate: 0.053
        minimum_population_pct: 0.30
        max_active_age: 50

# =========================================================================
# Marriage Configuration (TR2025 Intermediate Assumptions)
# =========================================================================
# Source: SSA 2025 Long-Range Model Documentation, Section 1.6

marriage:
  # Ultimate age-adjusted marriage rate (AMR)
  # Per 100,000 unmarried couples (geometric mean of male and female)
  ultimate_amr: 4000

  # Year when ultimate AMR is reached
  # TR2025 Section 1.6.a, Input #3: "The AMR reaches its ultimate value in the
  # 25th year of the 75-year projection period." The 75-year projection period
  # is 2025-2099 (Section 0). So: 2025 + 24 = 2049.
  # ultimate_year: derived from TR_YEAR + 24 (= 2049)

  # Age range for MarGrid
  min_age: 14
  max_age: 100  # 100+ grouped into single age

  # ACS data period for historical rates
  acs_start: 2008
  # acs_end: derived from TR_YEAR - 3 (= 2022)

  # TR2025 Section 1.6.b, Input #13: standard population year
  standard_population_year: 2010

  # Convergence: AMR(t) = ultimate + (starting - ultimate) * (1 - progress)^exponent
  # TR2025 Section 1.6.c Step 8: "annual rate of change decreases in absolute value"
  convergence_exponent: 2

  # Starting AMR = weighted avg of last N historical years
  # TR2025 Section 1.6.c Step 7: "weighted average of the rates for the past five
  # historical data years"
  starting_amr:
    n_years: 5
    weights: null  # null = equal weights; TR2025 says "weighted" but doesn't publish weights

  # Whittaker-Henderson smoothing parameters
  # TR2025 Section 1.6.c: "graduated using the two-dimensional Whittaker-Henderson method"
  smoothing:
    base:
      h_param: 1.0
      w_param: 1.0
    historical:
      h_param: 0.5
      w_param: 0.5
    max_iter: 100
    tol: 1.0e-6
    d: 2

  # Interpolation method: "beers" (TR2025) or "uniform" (legacy)
  interpolation_method: "beers"

  # Same-sex marriage configuration
  # DEVIATION: TR2025 Input #15 uses state vital statistics (2004-2012) for
  # same-sex marriage counts. These are not centrally published. ARTEMIS uses
  # ACS PUMS prevalence patterns (reference_years below) with a linear ramp
  # for 2004-2014 (pre-Obergefell). To swap data source, replace the
  # fetch_acs_same_sex_grids() function and update reference_years.
  same_sex:
    reference_years: [2015, 2016, 2017, 2018, 2019]
    default_fraction: 0.045       # Overall SS fraction from ACS 2015-2019
    default_mm_share: 0.459       # Male-male share of SS marriages (ACS)
    default_ff_share: 0.541       # Female-female share (ACS)
    min_count_threshold: 10       # Min cell count before using overall fraction

  # Prior marital status differentials (TR2025 Step 11)
  # DEVIATION: TR2025 Input #10 uses MRA-specific unmarried population by
  # prior status (1982-1988). Not in NBER public archive. ARTEMIS uses CPS
  # national unmarried population as a proxy. To swap, implement an MRA
  # population loader and change population_source to "mra".
  prior_status:
    years: [1979, 1981, 1982, 1983, 1984, 1985, 1986, 1987, 1988]
    n_statuses: 3
    population_source: "cps"  # "cps" (national proxy) or "mra" (if available)

# Divorce Configuration (TR2025 Intermediate Assumptions)
# =========================================================================
# Source: SSA 2025 Long-Range Model Documentation, Section 1.7

divorce:
  # Ultimate age-adjusted divorce rate (ADR)
  # Per 100,000 married couples
  ultimate_adr: 1700

  # Year when ultimate ADR is reached (25th year of 75-year projection period)
  # TR2025 Section 1.7.b, Input #6: projection period is 2025-2099, so 2025 + 24 = 2049
  # ultimate_year: derived from TR_YEAR + 24 (= 2049)

  # Age range for DivGrid
  min_age: 14
  max_age: 100  # 100+ grouped into single age

  # Standard population for ADR calculation
  # Per TR2025: "averaged 2009 and 2010 December 31 marriage grids"
  # DEVIATION: TR2025 Input #1 specifies grids "from the 2015 TR." ARTEMIS
  # computes these grids from Census/ACS data via the historical population
  # subprocess. Values may differ slightly from 2015 TR outputs.
  standard_population_years: [2009, 2010]

  # Convergence: ADR(t) = ultimate + (starting - ultimate) * (1 - progress)^exponent
  # TR2025 Section 1.7.c: "annual rate of change decreases in absolute value"
  convergence_exponent: 2

  # Starting ADR = weighted avg of last N historical years
  # TR2025 Section 1.7.c: "weighted average of the past five years of data"
  starting_adr:
    n_years: 5
    weights: null  # null = equal weights

  # DEVIATION: TR2025 uses 18-state health department data from ~2009-2012 (Input #10).
  # Not publicly available. ARTEMIS uses ACS PUMS divorced-in-past-12-months data.
  acs_years: [2018, 2019, 2020, 2021, 2022]

  # DEVIATION: TR2025 uses 2011 state data grid as adjustment target.
  # ARTEMIS uses ACS PUMS midpoint (~2020) since 18-state data unavailable.
  adjustment_year: 2020

  # Base period for DRA microdata DivGrid construction
  base_period_start: 1979
  base_period_end: 1988

  # Last year of historical divorce data (NCHS US totals)
  # For TR2026, update to 2023 (or whatever the last available data year is)
  # historical_end_year: derived from TR_YEAR - 3 (= 2022)

  # Maximum plausible divorce rate per 100,000 (cap for extreme cells)
  rate_cap: 50000

  # PR/VI divorce estimation parameters
  # Used for gap years when no NCHS or ACS data is available
  # DEVIATION: TR2025 Inputs #9 and #11 provide PR/VI data for 1988,
  # 1998-2000, and 2008-2022 only. For gap years (1989-1997, 2001-2007),
  # ARTEMIS interpolates using exponential decay from the 1988 anchor.
  pr_vi:
    anchor_1988_total: 13380   # Combined PR+VI divorces in 1988
    us_ratio: 0.012            # PR/VI as fraction of US divorces (~1.2%)
    vi_pr_ratio: 0.03          # VI divorces as fraction of PR divorces
    annual_decline: 0.99       # Annual decline factor for pre-2008 estimation
    dra_coverage: 0.48         # DRA coverage fraction of US divorces

# =========================================================================
# Projected Population Configuration (TR2025 Section 1.8)
# =========================================================================
# Source: SSA 2025 Long-Range Model Documentation, Section 1.8

projected_population:
  # Time period
  # starting_year: derived from projection_period.start_year - 1 (= 2022). December 31 basis
  # projection_start: derived from projection_period.start_year (= 2023)
  # projection_end: derived from projection_period.end_year (= 2100)

  # Use TR2025 historical population instead of our calculated historical population
  # This is useful for testing to isolate projection methodology differences
  # from historical population estimation differences
  use_tr_historical_population: false
  tr_historical_population_file: "data/raw/SSA_TR2025/SSPopDec_Alt2_TR2025.csv"

  # Reference date for population stocks
  reference_date: "dec31"  # December 31

  # Sex ratio at birth (males per 1000 females)
  # TR2025: "a sex ratio of 1,048 male births for every 1,000 female births"
  sex_ratio_at_birth: 1048

  # Population status parameters (for same-sex marriage modeling)
  # TR2025: "2.5% of the male population and 4.5% of the female population
  # is gay or lesbian"
  population_status:
    gay_percent: 0.025      # 2.5% of male population
    lesbian_percent: 0.045  # 4.5% of female population
    same_sex_start_year: 2013  # Federal recognition year

  # Net O immigration source for projection
  # "va2" = V.A2 totals with TR-derived distribution (default, matches TR2025)
  # "artemis" = ARTEMIS-computed O-immigration from full Section 1.5 pipeline
  net_o_source: "artemis"

  # Married couples grid (Phase 8C)
  # Source: ACS PUMS married-couple households (husband age × wife age)
  # TR2025 Input #10: empirical distribution used as base for IPF normalization
  couples_grid:
    reference_years: [2018, 2019, 2021, 2022]  # Exclude 2020 (COVID/no ACS 1-year)
    # IPF normalization parameters (applied to historical grid to match current marginals)
    ipf_max_iter: 50
    ipf_tolerance: 1.0e-6
    ipf_zero_replacement: 1.0e-10

  # CNI/civilian ratio computation (Phase 8E)
  # Source: historical_civilian_noninst target (Census ACS CNI data)
  cni:
    # Years to average CNI/civilian ratios over (more years = smoother ratios)
    # Excludes 2020 (no ACS 1-year due to COVID)
    ratio_years: [2010, 2011, 2012, 2013, 2014, 2015, 2016, 2017, 2018, 2019, 2021, 2022]
    # Separated/married ratio smoothing (TR2025 Input #20)
    # Source: historical CNI data with "separated" marital status from Census ACS
    separated_ratios:
      smoothing: "loess"       # "loess", "rolling_mean", or "none"
      smoothing_span: 0.3      # Span parameter for loess (lower = less smooth)

  # Armed forces data for CNI projection (Phase 8E)
  # Source: DoD DMDC via troopdata package + ACS PUMS (MIL=1)
  # Data years available: 2005-2023 (ACS PUMS), 1950-2024 (troopdata)
  armed_forces:
    military_age_range: [17, 65]  # Ages with active duty personnel
    # If true, hold AF constant at starting year through projection (TR2025 approach)
    hold_constant: true

  # Marital status projection parameters (Phase 8C)
  marital:
    midyear_ratio_cap: 2.0     # Cap for BOY-to-BOY ratio in midyear calculations

  # Children by parent fate parameters (Phase 8D)
  children:
    parent_age_groups:
      "14-24": [14, 24]
      "25-34": [25, 34]
      "35-44": [35, 44]
      "45-54": [45, 54]
      "55-64": [55, 64]
      "65-100": [65, 100]
    children_per_parent_bounds: [0.5, 5.0]  # Min/max children per parent in projection

  # Validation tolerances
  validation:
    marital_tolerance: 0.01        # Phase 8C marital totals vs Phase 8B (percent)
    children_fate_tolerance: 0.01  # Phase 8D children fate sum-to-total
    cni_tolerance: 0.02            # Phase 8E CNI validation
    comprehensive_tolerance: 0.02  # Phase 8F comprehensive validation
    orphan_rate_upper_bound: 0.15  # Maximum acceptable orphan rate

  # Age ranges
  ages:
    min_age: 0
    max_age: 100           # Maximum single year of age tracked (100 represents 100+)
    max_age_group: 100     # Open-ended age group (100+)
    mothers_min: 14        # Minimum mother's age for births
    mothers_max: 49        # Maximum mother's age for births
    children_max: 18       # Maximum age for "children" category
    marriage_min: 14       # Minimum marriage age

# Data source configuration
data_sources:
  historical_birth_data:
    start_year: 1980
    # end_year: derived from TR_YEAR - 1 (= 2024). Includes preliminary NCHS data.
  historical_rate_data:
    start_year: 1917
    end_year: 1979
  population_estimates:
    start_year: 1980
    # end_year: derived from TR_YEAR - 1 (= 2024)
  # ACS foreign-born flow years (PUMS microdata, 2020 excluded due to COVID)
  acs_foreign_born_years: [2006, 2007, 2008, 2009, 2010, 2011, 2012, 2013,
    2014, 2015, 2016, 2017, 2018, 2019, 2021, 2022, 2023]
  # ACS undercount factor reference years
  acs_undercount_years: [2017, 2018, 2019]

  # Census Bureau population estimates vintage
  # 2024: Latest data with 2020 Census revisions (default)
  # 2023: Earlier vintage, closer to what TR2025 used for 2020-2022
  # Note: Both vintages incorporate 2020 Census baseline, so 2019+ will
  # differ from TR2025 which used pre-2020 Census estimates
  census_vintage: 2024

  # =========================================================================
  # Census Undercount Methodology
  # =========================================================================
  # Controls which undercount factors are applied to Census population estimates
  # to derive the Social Security area population.
  #
  # Options:
  # - "DA": Demographic Analysis (Census Bureau official, single-year-of-age)
  #         Shows ages 18-24 OVERCOUNTED by ~3-8% in 2020 Census
  #         More methodologically rigorous; uses birth/death records
  #
  # - "PES": Post-Enumeration Survey based factors (hardcoded below)
  #          Shows ages 18-29 UNDERCOUNTED by ~1-2%
  #          Better matches TR2025 population; excludes college dorms
  #
  # TR2025 appears to use factors closer to PES methodology, resulting in
  # higher population for ages 18-24 than Census DA would suggest.
  census_undercount_method: "DA"

  # PES-based undercount factors by age group (used when census_undercount_method = "PES")
  # Source: Census Bureau Post-Enumeration Survey, 2020 Census
  # Reference: https://www.census.gov/newsroom/press-releases/2022/2020-census-estimates-of-undercount-and-overcount.html
  #
  # Note: PES found statistically significant undercounts for males 18-29 (2.25%)
  # and females 18-29 (0.98%). These differ from DA because PES excludes
  # group quarters like college dorms.
  pes_undercount_factors:
    # Age group: rate (positive = undercount, negative = overcount)
    age_0_4: 0.055       # 5.5% undercount (both DA and PES agree on young children)
    age_5_9: 0.010       # 1.0% undercount
    age_10_17: 0.005     # 0.5% undercount
    age_18_29_male: 0.015   # 2.25% undercount (PES finding)
    age_18_29_female: 0.0098 # 0.98% undercount (PES finding)
    age_30_49_male: 0.01   # 1.5% undercount (estimated)
    age_30_49_female: 0.005  # 0.5% undercount (estimated)
    age_50_plus: -0.005  # 0.5% overcount (slight overcount for older ages)

# =========================================================================
# Historical Population Configuration (TR2025 Section 1.4)
# =========================================================================
# Source: SSA 2025 Long-Range Model Documentation, Section 1.4
# All constants previously hardcoded in historical population R files.

historical_population:
  # Historical period boundaries
  # start_year: First year of historical population estimates
  # end_year: Last year before projection starts (= last year with Census/ACS data)
  # These change with each Trustees Report year
  start_year: 1940
  # end_year: derived from TR_YEAR - 3 (= 2022)

  # Data source for historical population estimation
  # "census": Census PEP + Eq 1.4.1 adjustments for all ages 0-100
  # "hybrid": Census PEP for ages 0-84, SSPopDec for ages 85+ (TR2025 default)
  # "ssa": SSPopDec for all ages 0-100 (uses SSA's published population directly)
  population_source: "census"

  # Civilian noninstitutionalized population start year
  # ACS PUMS data is available from 2005+, but TR2025 uses 2010+ for CNI
  cni_start_year: 2010

  # ACS survey years excluded from data (e.g., 2020 ACS was not conducted due to COVID)
  acs_excluded_years: [2020]

  # Maximum single year of age tracked (100 represents 100+)
  max_age: 100

  # Tab years: benchmark years with direct population estimates
  # Inter-tab years are interpolated using component method with closure ratios
  tab_years:
    early: [1940, 1950, 1956, 1960]
    annual_range: [1969, 2009]  # every year from 1969 through 2009
    final: [2022]              # Default: [TR_YEAR - 3] (= [2022]). Last historical year for TR2025

  # =========================================================================
  # Overseas Population Distributions
  # =========================================================================
  # Parameters for distributing aggregate overseas population totals
  # across single years of age and sex using Normal distributions.
  # Source: TR2025 Section 1.4, Equations 1.4.1
  overseas_distributions:
    federal_armed_forces:
      mean_age: 35
      sd_age: 12
      male_share: 0.65
      min_age: 18
      max_age_cutoff: 65
    beneficiaries:
      mean_age: 72
      sd_age: 10
      male_share: 0.45
      min_age_cutoff: 50
    dependents:
      mean_age: 25
      sd_age: 20
      male_share: 0.50
    other_citizens:
      mean_age: 45
      sd_age: 18
      male_share: 0.50

  # =========================================================================
  # Other Citizens Overseas Estimate
  # =========================================================================
  # Source: SSA Actuarial Study No. 112, Table 1
  # OTH = base_value * (0.5 + growth_dampening * (current_pop / base_pop))
  other_citizens_overseas:
    base_year: 1990
    base_value: 525000
    growth_dampening: 0.5

  # =========================================================================
  # Dependent Ratio
  # =========================================================================
  # Dependents = dependent_ratio * (armed_forces_overseas + fed_employees_overseas)
  # Source: TR2025 Section 1.4
  dependent_ratio: 0.50

  # =========================================================================
  # O-Population (Temporary/Unlawfully Present) Parameters
  # =========================================================================
  # Source: TR2025 Section 1.4, Equation 1.4.3
  o_population:
    # Method for computing O-population stock
    # "residual": Back out from population accounting identity (TR2025 methodology)
    # "va2_flows": Build stock from V.A2 net O flows (alternative)
    method: "residual"

    # COVID-19 adjustment for 2020 (TR2025 footnote 9)
    # Replace 2020 O-stock with average of 2019 and 2021 by age/sex
    covid_average_2020: true

    # Sex split for O-population (DHS unauthorized estimates)
    male_share: 0.57

    # Age distribution weights for O-population (used by va2_flows method)
    # Based on DHS/CMS unauthorized population estimates (modern era)
    # Each weight applies uniformly to all single-year ages within the group
    # Weights are raw (not normalized); code normalizes to sum to 1
    age_distribution:
      age_0_4: 0.002       # Very few young children
      age_5_9: 0.005       # Some children
      age_10_14: 0.008     # Older children
      age_15_17: 0.015     # Teenagers
      age_18_19: 0.020     # Young adults
      age_20_24: 0.025     # 20-24
      age_25_29: 0.035     # 25-29 peak
      age_30_34: 0.040     # 30-34 peak
      age_35_39: 0.035     # 35-39
      age_40_44: 0.025     # 40-44
      age_45_49: 0.018     # 45-49
      age_50_54: 0.012     # 50-54
      age_55_59: 0.008     # 55-59
      age_60_64: 0.005     # 60-64
      age_65_69: 0.003     # 65-69
      age_70_79: 0.001     # 70-79
      age_80_plus: 0.0005  # 80+

    # Era-based distributions for va2_flows method (Phase 6)
    # When enabled, the va2_flows method uses era-specific age-sex distributions
    # instead of the single static distribution above. The residual method
    # already derives year-varying distributions from data and does not use these.
    # Eras are applied based on year; years between eras interpolate linearly.
    era_distributions:
      enabled: true
      eras:
        # Pre-1980: Bracero-era pattern — mostly adult male agricultural workers
        # Source: INS estimates, Bracero program records (1942-1964)
        - start_year: 1940
          end_year: 1979
          male_share: 0.75
          age_distribution:
            age_0_4: 0.001
            age_5_9: 0.002
            age_10_14: 0.003
            age_15_17: 0.010
            age_18_19: 0.025
            age_20_24: 0.050
            age_25_29: 0.060
            age_30_34: 0.050
            age_35_39: 0.040
            age_40_44: 0.030
            age_45_49: 0.020
            age_50_54: 0.010
            age_55_59: 0.005
            age_60_64: 0.002
            age_65_69: 0.001
            age_70_79: 0.0005
            age_80_plus: 0.0001
        # 1980-1999: Growing unauthorized immigration, more families
        # Source: INS/CIS estimates, Warren & Passel (1987), Passel (2002)
        - start_year: 1980
          end_year: 1999
          male_share: 0.65
          age_distribution:
            age_0_4: 0.002
            age_5_9: 0.004
            age_10_14: 0.006
            age_15_17: 0.012
            age_18_19: 0.022
            age_20_24: 0.035
            age_25_29: 0.045
            age_30_34: 0.045
            age_35_39: 0.035
            age_40_44: 0.025
            age_45_49: 0.018
            age_50_54: 0.010
            age_55_59: 0.006
            age_60_64: 0.003
            age_65_69: 0.002
            age_70_79: 0.001
            age_80_plus: 0.0003
        # 2000+: Modern DHS-measured pattern (same as static distribution)
        - start_year: 2000
          end_year: 2099
          male_share: 0.57
          age_distribution:
            age_0_4: 0.002
            age_5_9: 0.005
            age_10_14: 0.008
            age_15_17: 0.015
            age_18_19: 0.020
            age_20_24: 0.025
            age_25_29: 0.035
            age_30_34: 0.040
            age_35_39: 0.035
            age_40_44: 0.025
            age_45_49: 0.018
            age_50_54: 0.012
            age_55_59: 0.008
            age_60_64: 0.005
            age_65_69: 0.003
            age_70_79: 0.001
            age_80_plus: 0.0005

    # Emigration as fraction of LPR immigration (for O-population calculation)
    emigration_ratio: 0.25

    # Adjustment of Status as fraction of LPR immigration
    aos_ratio: 0.40

    # Residual modification parameters (TR2025 Section 1.4.c Eq 1.4.3:
    # "These residuals are then modified to ensure reasonableness")
    residual_smoothing:
      # Rolling median window for per-(age,sex) time series smoothing (must be odd)
      rolling_median_window: 11
      # Floor negative residuals at 0 before computing proportions.
      # Residuals are only used for age-sex SHAPE (V.A2 provides LEVELS),
      # so negative values should not contribute to the distribution.
      floor_at_zero: true

  # =========================================================================
  # Territory Age Distribution Parameters
  # =========================================================================
  # Used to distribute territory population totals across ages
  # when single-year-of-age data is not available (pre-IDB years)
  territory_age_distribution:
    young_children_weight: 0.07     # age < 5
    children_weight: 0.065          # age 5-17
    working_age_base_weight: 0.055  # age 18-64 base
    working_age_decay: 0.01         # exponential decay rate
    working_age_center: 30          # center age for decay
    elderly_base_weight: 0.03       # age 65+ base
    elderly_decay: 0.03             # exponential decay rate
    male_share_under_65: 0.51
    male_share_65_plus: 0.45

  # Per TR2025 documentation: "2020 data is assumed to be the same as 2010
  # until the data is available to OCACT."
  armed_forces_territories_2020_equals_2010: true

# =============================================================================
# ECONOMICS PROCESS
# =============================================================================

economics:
  employment:
    # Data source for historical economic assumptions
    # "api" = fetch from BLS/BEA/FRED (default); "tr2025" = use SingleYear tables for all
    assumptions_data_source: "api"

    # Base year for projections (derived from trustees_report_year - 1 if null)
    base_year: null
    # End year for projections (derived from metadata.projection_period.end_year if null)
    end_year: null
    # Historical data start year for model estimation context
    historical_start_year: 1968

    # Quarterly frequency flag
    quarterly: true

    # Ultimate unemployment rate (from Trustees intermediate assumptions)
    # Ref: Table V.B2 in SingleYearTRTables_TR2025.xlsx
    ultimate_unemployment_rate: 5.5
    ultimate_unemployment_year: 2034

    # Okun's Law coefficient for RTP construction
    # RTP = 1 + (u* - u) * okun_coefficient / 100
    # Ref: Economics overview documentation
    okun_coefficient: 2.0

    # Military population held constant at this year's level (Eq 2.1.1)
    military_constant_year: 2021

    # LFPR age decay factors
    # Ages 75-79: multiply prior cohort LFPR by this factor (4-year lag)
    lfpr_decay_75_79:
      male: 0.92
      female: 0.90
    # Ages 80+: multiply by this factor per year of age
    lfpr_decay_80_plus: 0.965

    # Number of years after base_year to freeze LFPR time trends.
    # After this many years, the trend term stops accumulating and holds constant.
    # Set to null to never freeze (trend accumulates forever — not recommended).
    # TR2025 documentation states ultimate values are reached "during the last
    # half of the short range (first 10 years)."
    lfpr_trend_freeze_years: 10

    # Maximum allowed deviation of MSSHARE from base-year values for LFPR equations.
    # Prevents extrapolation outside the coefficient estimation range.
    # Set to null to use uncapped demography projections.
    # A value of 0.10 limits MSSHARE change to ±10pp from base year.
    msshare_max_deviation: 0.10

    # Addfactors: manual adjustments to LFPR equations
    # Default to null (zero); override per age-sex group as needed
    # Format: { "age_group": { "male": value, "female": value } }
    addfactors: null

    # EO (Employed OP) configuration
    employed_op:
      enabled: true
      # Conversion weight method for TEO
      teo_method: "age_sex_ratio"

    # Exogenous inputs from Beneficiaries subprocess (TR2025 data)
    # To be replaced with computed values when Beneficiaries is implemented
    exogenous:
      disability_prevalence_source: "tr2025"  # "tr2025" or "computed"
      pia_replacement_source: "tr2025"        # "tr2025" or "computed"
      nra_source: "tr2025"                    # "tr2025" or "computed"
